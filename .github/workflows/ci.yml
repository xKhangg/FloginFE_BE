name: CI Pipeline

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-and-test:
    # KHUYẾN NGHỊ: Giữ nguyên Ubuntu để chạy được MySQL Service dễ dàng
    runs-on: ubuntu-latest

    # Cấu hình MySQL Service (Backend cần cái này để chạy)
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: FloginFE_BE
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      # --- 1. SETUP CHUNG ---
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # --- 2. BACKEND: BUILD & UNIT TEST ---
      - name: Backend - Build & Unit Test
        run: |
          cd backend
          mvn clean test
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/FloginFE_BE
          SPRING_DATASOURCE_USERNAME: root
          SPRING_DATASOURCE_PASSWORD: root

      # --- 3. FRONTEND: INSTALL & UNIT TEST ---
      - name: Frontend - Install Dependencies
        run: |
          cd frontend
          npm ci

      - name: Frontend - Unit Test
        run: |
          cd frontend
          npm test -- --watchAll=false --passWithNoTests

      # --- 4. CHUẨN BỊ E2E: KHỞI ĐỘNG SERVER ---

      # Bước này build ra file .jar để chạy server nhẹ hơn
      - name: Backend - Build JAR (Skip Tests)
        run: |
          cd backend
          ./mvnw package -DskipTests

      # Chạy Backend trong background (&)
      - name: Start Backend Server
        run: |
          cd backend
          java -jar target/*.jar &
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/FloginFE_BE
          SPRING_DATASOURCE_USERNAME: root
          SPRING_DATASOURCE_PASSWORD: root
          SERVER_PORT: 8080

      # Chạy Frontend trong background (&)
      - name: Start Frontend Server
        run: |
          cd frontend
          npm run dev & 

      # --- 5. CHẠY E2E TESTS (CYPRESS) ---
      - name: Cypress Run
        uses: cypress-io/github-action@v6
        with:
          working-directory: frontend
          # Tự động đợi Frontend (5173) và Backend (8080) sẵn sàng rồi mới test
          wait-on: 'http://localhost:3000, http://localhost:8080'
          wait-on-timeout: 120 # Đợi tối đa 120 giây
          browser: chrome
        env:
          # Cấu hình biến môi trường cho Cypress nếu cần (để fix lỗi HTTPS certificate)
          CYPRESS_chromeWebSecurity: false

      # --- 6. UPLOAD COVERAGE ---
      - name: Upload coverage to Codecov
        if: always() # Luôn chạy dù test có fail để xem fail ở đâu
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}