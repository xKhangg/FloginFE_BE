name: Product CI Pipeline

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: FloginFE_BE
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      # --- 1. SETUP CHUNG ---
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # --- 2. BACKEND: BUILD & UNIT TEST (CHỈ PRODUCT) ---
      - name: Backend - Unit Test (Product Only)
        run: |
          cd backend
          # Thêm -Dtest=*Product* để chỉ chạy các file test có tên chứa chữ Product
          mvn clean test -Dtest=*Product*
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/FloginFE_BE
          SPRING_DATASOURCE_USERNAME: root
          SPRING_DATASOURCE_PASSWORD: root

      # --- 3. FRONTEND: INSTALL & UNIT TEST (CHỈ PRODUCT) ---
      - name: Frontend - Install Dependencies
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Frontend - Unit Test (Product Only)
        # THÊM DÒNG NÀY: Cho phép chạy tiếp dù test frontend bị fail
        continue-on-error: true
        run: |
          cd frontend
          # Thêm từ khóa 'Product' để Jest chỉ chạy các file test liên quan đến Product
          npm test -- Product --watchAll=false --passWithNoTests

      # --- 4. CHUẨN BỊ E2E: KHỞI ĐỘNG SERVER ---
      - name: Backend - Build JAR (Skip Tests)
        run: |
          cd backend
          mvn package -DskipTests

      - name: Start Backend Server
        run: |
          cd backend
          java -jar target/*.jar &
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/FloginFE_BE
          SPRING_DATASOURCE_USERNAME: root
          SPRING_DATASOURCE_PASSWORD: root
          SERVER_PORT: 8080

      - name: Start Frontend Server
        run: |
          cd frontend
          npx serve -s build -l 3000 &
        env:
          BROWSER: none

      # --- 5. CHẠY E2E TESTS (CHỈ PRODUCT) ---
      - name: Cypress Run (Product Spec Only)
        uses: cypress-io/github-action@v6
        with:
          working-directory: frontend
          wait-on: 'http://localhost:3000, http://localhost:8080'
          wait-on-timeout: 300
          browser: chrome
          # Chỉ chạy các file test E2E có tên chứa chữ "product"
          spec: cypress/e2e/*product*.cy.js
        env:
          CYPRESS_chromeWebSecurity: false

      # --- 6. UPLOAD COVERAGE ---
      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}