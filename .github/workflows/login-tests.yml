name: login-tests CI
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: FloginFE_BE
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Backend - Unit Test (Login)
        run: |
          cd backend
          mvn clean test -Dtest=*Auth*
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/FloginFE_BE
          SPRING_DATASOURCE_USERNAME: root
          SPRING_DATASOURCE_PASSWORD: root  # <-- Đã sửa: Phải điền root vào đây

      - name: Frontend - Install Dependencies
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Frontend - Unit Test (Login)
        continue-on-error: true
        run: |
          cd frontend
          npm test -- src/tests/Login --watchAll=false --passWithNoTests

      - name: Backend - Build JAR (Skip Tests)
        run: |
          cd backend
          mvn package -DskipTests
          

      - name: Start Backend Server
        run: |
          cd backend
          java -jar target/*.jar &
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/FloginFE_BE
          SPRING_DATASOURCE_USERNAME: root
          SPRING_DATASOURCE_PASSWORD: root
          SERVER_PORT: 8080

      - name: Wait for Backend & Seed Data
        run: |
          sleep 20 # Đợi Server khởi động
          mysql -h 127.0.0.1 -u root -proot FloginFE_BE -e "INSERT INTO users (username, password) SELECT 'testuser', 'Test123' FROM dual WHERE NOT EXISTS (SELECT 1 FROM users WHERE username = 'testuser');" || true

      - name: Start Frontend Server
        run: |
          cd frontend
          npx serve -s build -l 3000 &
        env:
          BROWSER: none

      - name: Cypress Run (Login)
        uses: cypress-io/github-action@v6
        with:
          working-directory: frontend
          config-file: src/cypress.config.js
          wait-on: 'http://localhost:3000, http://localhost:8080/api/products?page=0'
          wait-on-timeout: 300
          browser: chrome
          spec: src/cypress/e2e/*login*.cy.js
        env:
          CYPRESS_chromeWebSecurity: false

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}